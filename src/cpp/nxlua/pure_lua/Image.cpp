#include "Image.h"
#include "niu2x/pipe.h"

static const uint8_t luacode_bytearray[] = { 120, 156, 181, 86, 203, 110, 219,
    48, 16, 60, 219, 95, 193, 35, 221, 210, 143, 56, 57, 25, 232, 185, 232, 189,
    119, 129, 145, 105, 75, 40, 37, 10, 36, 93, 75, 253, 250, 46, 159, 34, 37,
    197, 77, 80, 4, 8, 2, 121, 103, 102, 119, 184, 75, 82, 42, 190, 239, 126,
    52, 244, 202, 208, 55, 84, 114, 170, 20, 222, 172, 215, 151, 91, 91, 234,
    90, 180, 200, 34, 167, 82, 11, 9, 225, 149, 98, 252, 178, 123, 165, 229, 47,
    214, 158, 11, 224, 215, 6, 45, 52, 64, 16, 152, 169, 184, 160, 103, 220, 81,
    93, 181, 180, 97, 160, 150, 76, 223, 100, 139, 178, 36, 83, 210, 82, 30, 69,
    127, 179, 127, 230, 153, 144, 150, 242, 220, 235, 179, 174, 48, 218, 237,
    118, 232, 173, 44, 142, 178, 44, 175, 88, 125, 173, 244, 99, 189, 231, 44,
    39, 144, 76, 213, 127, 24, 190, 19, 84, 77, 123, 153, 99, 75, 226, 75, 205,
    57, 150, 228, 74, 94, 9, 157, 169, 115, 208, 202, 185, 40, 41, 71, 49, 137,
    20, 154, 106, 86, 116, 162, 110, 53, 238, 9, 26, 8, 162, 237, 149, 39, 237,
    236, 209, 23, 212, 64, 255, 118, 165, 80, 216, 97, 104, 139, 134, 16, 85,
    117, 235, 163, 4, 141, 220, 49, 138, 190, 142, 220, 49, 131, 243, 50, 107,
    132, 53, 19, 40, 43, 103, 181, 162, 252, 82, 220, 97, 83, 153, 165, 133, 65,
    236, 143, 25, 92, 5, 56, 244, 121, 196, 251, 39, 88, 212, 19, 224, 91, 151,
    136, 248, 135, 42, 18, 142, 64, 56, 166, 132, 9, 254, 12, 248, 51, 224, 111,
    192, 47, 0, 191, 36, 112, 72, 191, 94, 197, 210, 121, 147, 109, 116, 108,
    115, 172, 159, 179, 108, 52, 97, 5, 23, 57, 203, 70, 19, 86, 48, 147, 179,
    108, 52, 178, 130, 243, 134, 246, 69, 15, 92, 59, 26, 248, 129, 227, 131,
    177, 216, 31, 97, 160, 99, 4, 138, 244, 47, 155, 77, 170, 29, 22, 181, 102,
    105, 67, 166, 53, 6, 7, 163, 141, 226, 186, 77, 10, 195, 78, 137, 15, 147,
    194, 38, 50, 45, 12, 218, 97, 81, 59, 41, 108, 34, 177, 112, 80, 183, 236,
    110, 183, 146, 91, 250, 214, 57, 73, 193, 202, 131, 131, 7, 135, 40, 133,
    131, 120, 227, 26, 96, 187, 85, 177, 61, 31, 38, 18, 78, 168, 77, 77, 92,
    146, 17, 180, 7, 240, 64, 144, 255, 75, 172, 104, 73, 91, 117, 17, 178, 25,
    175, 203, 16, 41, 244, 201, 62, 115, 115, 24, 182, 54, 241, 30, 182, 130,
    125, 170, 246, 71, 200, 158, 138, 227, 243, 169, 185, 113, 60, 79, 149, 29,
    170, 15, 106, 71, 27, 249, 230, 55, 121, 60, 219, 172, 159, 54, 29, 103,
    120, 189, 202, 111, 159, 176, 234, 244, 220, 146, 252, 152, 18, 208, 184,
    78, 205, 84, 105, 63, 13, 45, 218, 90, 175, 204, 78, 242, 151, 147, 19, 175,
    23, 111, 198, 82, 138, 206, 95, 105, 254, 106, 125, 223, 36, 29, 249, 163,
    115, 58, 32, 114, 120, 95, 87, 70, 75, 15, 150, 31, 224, 135, 203, 94, 124,
    41, 130, 105, 246, 83, 224, 79, 91, 178, 45, 128, 179, 203, 248, 142, 72,
    126, 251, 86, 159, 191, 63, 254, 175, 65, 88, 193, 20, 212, 96, 94, 152,
    230, 54, 129, 127, 66, 34, 213, 103, 111, 239, 216, 74, 111, 60, 120, 132,
    183, 25, 168, 67, 48, 88, 53, 209, 193, 120, 176, 53, 183, 91, 59, 102, 84,
    43, 196, 217, 69, 107, 209, 161, 78, 168, 218, 216, 152, 250, 57, 75, 122,
    199, 74, 150, 110, 99, 128, 35, 208, 186, 57, 64, 176, 176, 53, 141, 67, 89,
    198, 143, 144, 156, 225, 12, 120, 74, 252, 206, 72, 72, 15, 199, 233, 211,
    45, 12, 11, 162, 43, 72, 57, 31, 87, 112, 69, 146, 242, 196, 243, 151, 118,
    250, 35, 65, 50, 61, 248, 57, 251, 126, 9, 189, 153, 228, 220, 216, 3, 255,
    23, 55, 65, 109, 68 };

#include <iostream>
#include <sstream>

void pure_lua_Image_open(lua_State* L)
{

    std::string luacode(
        luacode_bytearray, luacode_bytearray + sizeof(luacode_bytearray));
    std::istringstream is(luacode);
    nx::pipe::source_t source(is);

    std::stringstream out;
    nx::pipe::sink_t sink(out);

    nx::pipe::filter::unzlib_t unzlib;

    source | unzlib | sink;

    if (luaL_dostring(L, out.str().c_str())) {
        std::cerr << lua_tostring(L, -1) << std::endl;
    }
}
#include "deferred.h"
#include "niu2x/pipe.h"

static const uint8_t luacode_bytearray[] = { 120, 156, 189, 89, 109, 111, 27,
    55, 18, 254, 44, 253, 10, 34, 247, 65, 90, 84, 146, 147, 166, 253, 98, 192,
    135, 203, 165, 190, 34, 135, 36, 13, 146, 190, 160, 8, 2, 131, 90, 81, 22,
    47, 171, 93, 117, 201, 181, 173, 11, 124, 191, 253, 102, 134, 28, 146, 75,
    173, 108, 29, 218, 158, 97, 120, 119, 201, 225, 204, 112, 94, 158, 25, 210,
    243, 249, 92, 188, 248, 74, 236, 218, 102, 171, 141, 50, 66, 215, 226, 117,
    39, 23, 227, 57, 140, 255, 109, 219, 172, 186, 74, 137, 149, 90, 171, 182,
    85, 171, 241, 184, 106, 74, 89, 137, 55, 226, 66, 124, 185, 231, 47, 158,
    117, 131, 252, 181, 184, 186, 210, 245, 74, 221, 193, 104, 190, 252, 221,
    229, 219, 239, 94, 189, 253, 30, 102, 158, 250, 145, 247, 151, 31, 126, 120,
    253, 179, 27, 123, 22, 198, 254, 121, 249, 242, 71, 55, 246, 117, 143, 238,
    242, 59, 24, 122, 222, 35, 163, 161, 111, 88, 192, 186, 171, 75, 171, 155,
    90, 172, 117, 173, 205, 102, 202, 10, 204, 132, 177, 210, 170, 98, 60, 162,
    39, 44, 113, 207, 166, 13, 108, 198, 163, 53, 124, 233, 153, 88, 163, 37,
    244, 78, 234, 214, 132, 245, 139, 223, 58, 213, 169, 66, 172, 154, 241, 104,
    164, 215, 126, 245, 197, 69, 212, 203, 110, 84, 13, 115, 163, 245, 121, 171,
    76, 83, 221, 168, 184, 246, 70, 86, 29, 138, 30, 169, 202, 40, 166, 249,
    151, 42, 237, 16, 73, 189, 26, 187, 63, 97, 174, 167, 241, 24, 231, 242,
    205, 106, 195, 175, 211, 53, 48, 1, 253, 236, 126, 167, 224, 29, 53, 156,
    88, 185, 172, 212, 132, 21, 116, 75, 183, 22, 24, 94, 43, 187, 85, 192, 20,
    231, 105, 225, 168, 85, 182, 107, 107, 156, 253, 207, 133, 168, 117, 37,
    100, 189, 114, 188, 182, 22, 220, 10, 43, 43, 199, 147, 229, 77, 188, 178,
    126, 97, 42, 54, 146, 12, 169, 236, 163, 46, 113, 80, 173, 238, 44, 184,
    169, 43, 75, 101, 12, 120, 65, 234, 170, 107, 21, 140, 55, 181, 39, 46, 151,
    201, 230, 120, 97, 111, 143, 65, 221, 204, 176, 57, 77, 98, 48, 20, 91, 244,
    141, 131, 219, 164, 160, 94, 75, 231, 48, 55, 220, 124, 158, 9, 96, 10, 227,
    59, 164, 152, 58, 133, 251, 146, 102, 97, 135, 211, 27, 52, 40, 170, 235,
    217, 161, 8, 225, 237, 68, 54, 27, 141, 130, 32, 219, 118, 20, 24, 125, 102,
    48, 113, 131, 163, 222, 38, 83, 31, 31, 127, 138, 12, 111, 110, 150, 81,
    184, 48, 175, 27, 11, 219, 38, 147, 225, 107, 34, 101, 144, 19, 124, 13,
    240, 26, 115, 220, 167, 158, 196, 73, 156, 27, 138, 141, 181, 110, 19, 255,
    142, 189, 249, 209, 220, 135, 238, 31, 112, 176, 87, 15, 233, 19, 8, 114,
    132, 11, 199, 133, 180, 58, 22, 130, 193, 186, 168, 255, 65, 22, 6, 192,
    130, 201, 92, 209, 190, 115, 142, 44, 247, 216, 118, 210, 114, 14, 188, 240,
    122, 227, 252, 146, 179, 77, 212, 202, 227, 59, 146, 186, 40, 10, 177, 62,
    194, 120, 190, 9, 209, 156, 211, 229, 145, 205, 248, 117, 68, 58, 35, 246,
    49, 233, 62, 38, 30, 149, 30, 210, 254, 80, 58, 110, 28, 130, 145, 25, 60,
    236, 26, 231, 98, 250, 59, 230, 149, 30, 211, 152, 193, 49, 118, 189, 188,
    96, 200, 62, 50, 205, 192, 151, 149, 155, 98, 72, 131, 156, 67, 140, 205,
    227, 25, 229, 172, 3, 99, 77, 59, 19, 19, 87, 89, 116, 125, 205, 240, 41,
    110, 181, 221, 8, 109, 141, 170, 214, 19, 18, 122, 92, 31, 222, 201, 73, 97,
    143, 193, 153, 21, 80, 174, 116, 188, 183, 100, 5, 215, 214, 161, 101, 113,
    238, 48, 188, 7, 200, 31, 139, 236, 92, 139, 180, 102, 22, 131, 104, 146,
    151, 99, 175, 18, 68, 159, 15, 172, 193, 136, 126, 202, 62, 57, 244, 59, 62,
    135, 82, 219, 213, 231, 193, 180, 14, 5, 50, 52, 68, 164, 233, 124, 14, 191,
    226, 221, 79, 127, 127, 253, 234, 165, 120, 241, 238, 21, 14, 4, 189, 153,
    52, 244, 19, 172, 175, 103, 197, 195, 232, 251, 89, 180, 82, 216, 23, 73,
    24, 226, 70, 157, 199, 35, 204, 124, 58, 247, 153, 97, 99, 248, 158, 232,
    141, 144, 16, 53, 183, 33, 12, 155, 37, 50, 245, 173, 163, 245, 60, 223,
    249, 201, 183, 145, 208, 17, 116, 70, 94, 187, 215, 131, 54, 178, 85, 191,
    117, 104, 190, 9, 143, 65, 84, 207, 201, 76, 115, 17, 30, 226, 101, 83, 223,
    168, 214, 98, 34, 96, 126, 44, 101, 249, 121, 190, 148, 6, 56, 128, 17, 161,
    123, 179, 13, 11, 244, 195, 218, 8, 88, 176, 7, 23, 181, 82, 95, 111, 44,
    116, 122, 183, 178, 93, 157, 103, 124, 159, 21, 226, 101, 171, 208, 155,
    253, 141, 241, 252, 215, 133, 248, 96, 101, 107, 197, 190, 233, 90, 33, 205,
    190, 46, 55, 109, 83, 55, 29, 216, 131, 204, 204, 132, 207, 11, 48, 20, 89,
    52, 227, 36, 110, 33, 170, 20, 232, 226, 23, 160, 102, 46, 7, 64, 203, 105,
    83, 87, 123, 172, 126, 198, 58, 135, 116, 41, 79, 248, 209, 40, 167, 84, 59,
    139, 81, 220, 64, 128, 182, 48, 208, 42, 161, 175, 235, 134, 98, 205, 147,
    126, 131, 226, 73, 220, 9, 210, 1, 112, 15, 100, 35, 177, 155, 79, 164, 159,
    36, 250, 219, 194, 135, 72, 46, 186, 82, 54, 56, 12, 159, 70, 175, 148, 0,
    71, 201, 213, 10, 130, 169, 220, 72, 104, 186, 155, 117, 240, 167, 129, 185,
    68, 246, 161, 193, 57, 178, 67, 120, 36, 9, 47, 87, 216, 206, 206, 105, 169,
    15, 177, 180, 19, 128, 200, 157, 242, 52, 18, 19, 223, 233, 58, 1, 167, 178,
    169, 173, 170, 173, 161, 134, 143, 73, 201, 3, 107, 215, 2, 38, 149, 36, 78,
    10, 17, 147, 149, 57, 164, 139, 9, 129, 115, 114, 202, 198, 76, 10, 102,
    155, 251, 34, 84, 99, 77, 29, 130, 208, 167, 167, 96, 11, 253, 218, 116, 96,
    185, 26, 154, 180, 91, 209, 129, 205, 201, 4, 133, 168, 244, 103, 176, 241,
    70, 27, 23, 232, 52, 58, 89, 131, 191, 23, 246, 206, 78, 138, 115, 4, 254,
    105, 68, 241, 168, 194, 174, 133, 36, 154, 78, 254, 225, 73, 5, 239, 230,
    92, 76, 0, 62, 139, 168, 92, 98, 179, 222, 30, 60, 131, 75, 44, 92, 147,
    196, 138, 180, 159, 224, 169, 55, 228, 138, 102, 135, 31, 198, 33, 113, 210,
    59, 240, 120, 191, 57, 71, 79, 190, 241, 46, 60, 214, 153, 251, 149, 80, 77,
    250, 125, 108, 40, 179, 61, 187, 115, 165, 14, 6, 118, 223, 158, 9, 48, 229,
    55, 56, 30, 194, 49, 151, 245, 128, 19, 26, 158, 123, 99, 167, 25, 13, 73,
    32, 154, 159, 100, 168, 98, 197, 86, 54, 108, 227, 139, 39, 196, 10, 146,
    45, 161, 35, 136, 239, 135, 96, 9, 168, 21, 181, 89, 184, 129, 123, 238,
    140, 14, 42, 102, 114, 38, 37, 13, 227, 185, 52, 105, 169, 184, 163, 203,
    91, 185, 129, 197, 238, 192, 154, 173, 37, 2, 234, 187, 23, 186, 54, 128,
    201, 83, 127, 84, 118, 93, 69, 210, 7, 177, 121, 93, 3, 78, 205, 0, 60, 184,
    118, 62, 197, 15, 90, 72, 119, 9, 52, 21, 204, 194, 59, 102, 243, 140, 195,
    17, 35, 153, 100, 67, 141, 71, 247, 206, 51, 38, 61, 221, 38, 157, 197, 177,
    56, 243, 6, 13, 225, 214, 31, 158, 30, 84, 242, 211, 106, 34, 112, 147, 22,
    113, 214, 91, 127, 69, 24, 44, 32, 74, 227, 197, 11, 226, 40, 79, 159, 57,
    67, 3, 74, 185, 90, 185, 147, 173, 220, 2, 197, 181, 129, 108, 6, 108, 6,
    136, 236, 213, 210, 255, 161, 216, 6, 252, 195, 20, 249, 18, 82, 117, 99,
    237, 110, 113, 173, 32, 91, 241, 237, 252, 236, 76, 221, 201, 237, 14, 28,
    90, 54, 219, 51, 42, 8, 147, 98, 118, 26, 53, 28, 236, 154, 122, 117, 50,
    57, 32, 83, 155, 80, 223, 231, 128, 4, 54, 233, 170, 62, 132, 194, 203, 6,
    218, 192, 138, 12, 134, 147, 2, 42, 145, 18, 83, 180, 39, 246, 14, 202, 88,
    103, 207, 80, 84, 233, 74, 128, 136, 54, 210, 136, 165, 234, 33, 54, 188,
    212, 141, 160, 246, 58, 17, 211, 199, 181, 7, 181, 112, 75, 127, 183, 18,
    18, 235, 163, 68, 247, 214, 158, 103, 145, 22, 128, 4, 48, 209, 119, 24, 13,
    225, 88, 220, 195, 67, 8, 236, 191, 80, 172, 164, 29, 44, 7, 108, 0, 128,
    47, 247, 28, 203, 254, 50, 72, 217, 77, 131, 124, 158, 120, 138, 39, 60,
    179, 3, 42, 44, 214, 23, 142, 45, 15, 179, 237, 221, 93, 224, 40, 107, 184,
    185, 74, 235, 127, 171, 118, 170, 103, 33, 180, 147, 11, 166, 120, 129, 17,
    208, 196, 243, 252, 168, 63, 37, 61, 54, 99, 119, 72, 158, 0, 74, 169, 206,
    152, 48, 79, 18, 164, 137, 90, 243, 27, 180, 118, 158, 91, 152, 75, 12, 4,
    5, 225, 163, 227, 247, 9, 129, 34, 56, 252, 0, 187, 88, 173, 112, 73, 231,
    239, 12, 241, 238, 114, 22, 88, 211, 29, 33, 154, 11, 246, 226, 34, 58, 183,
    8, 94, 197, 20, 179, 3, 67, 209, 117, 83, 241, 135, 225, 12, 30, 13, 97,
    135, 78, 107, 131, 200, 97, 48, 56, 107, 171, 193, 91, 114, 183, 171, 116,
    41, 201, 97, 48, 19, 239, 94, 106, 108, 202, 148, 44, 55, 208, 174, 168, 45,
    80, 227, 109, 40, 178, 65, 248, 89, 224, 60, 8, 81, 119, 59, 2, 41, 164,
    109, 135, 218, 61, 143, 94, 129, 237, 86, 238, 78, 195, 51, 55, 191, 142,
    252, 58, 195, 98, 92, 63, 205, 170, 28, 172, 244, 122, 244, 140, 51, 124,
    222, 208, 86, 109, 41, 120, 39, 146, 26, 33, 56, 89, 47, 249, 165, 164, 151,
    123, 110, 172, 222, 67, 203, 36, 158, 11, 236, 153, 160, 44, 99, 118, 46,
    247, 248, 232, 3, 42, 236, 110, 74, 76, 103, 212, 99, 229, 56, 70, 171, 35,
    126, 32, 122, 40, 66, 135, 10, 111, 221, 193, 159, 160, 117, 219, 202, 61,
    57, 2, 6, 67, 187, 37, 48, 186, 200, 23, 48, 131, 27, 167, 37, 143, 119, 95,
    41, 74, 74, 138, 73, 194, 148, 193, 14, 12, 117, 71, 119, 0, 175, 122, 24,
    84, 6, 114, 62, 79, 249, 85, 67, 59, 214, 190, 221, 210, 226, 175, 30, 135,
    210, 142, 203, 129, 79, 146, 93, 225, 58, 188, 158, 250, 116, 25, 168, 0,
    197, 97, 139, 225, 89, 80, 166, 186, 105, 150, 255, 213, 179, 129, 155, 6,
    223, 228, 29, 182, 125, 249, 253, 193, 152, 249, 60, 43, 126, 127, 250, 1,
    206, 155, 6, 76, 35, 141, 247, 92, 235, 98, 22, 63, 66, 229, 135, 202, 104,
    254, 31, 165, 159, 154, 127, 214, 158, 53, 39, 149, 189, 6, 78, 176, 144,
    107, 139, 135, 67, 81, 130, 153, 241, 64, 102, 245, 86, 53, 157, 237, 159,
    175, 252, 32, 180, 185, 229, 137, 135, 44, 131, 103, 63, 183, 40, 185, 255,
    137, 21, 48, 56, 102, 242, 163, 35, 155, 100, 197, 56, 17, 117, 244, 24, 20,
    175, 16, 209, 212, 73, 131, 67, 199, 30, 211, 108, 21, 102, 15, 192, 46, 25,
    131, 76, 110, 250, 247, 104, 241, 212, 7, 105, 231, 52, 50, 110, 38, 166,
    15, 254, 240, 94, 190, 125, 172, 117, 201, 122, 6, 202, 237, 91, 105, 72,
    35, 110, 246, 215, 93, 85, 237, 23, 139, 197, 145, 238, 35, 59, 25, 226,
    158, 53, 118, 18, 172, 4, 170, 250, 234, 236, 7, 167, 97, 100, 147, 103,
    185, 179, 201, 241, 198, 1, 129, 230, 10, 47, 100, 227, 191, 190, 136, 216,
    21, 179, 155, 35, 105, 217, 203, 234, 195, 255, 78, 112, 154, 13, 28, 183,
    142, 23, 185, 23, 193, 39, 14, 25, 211, 252, 194, 35, 174, 177, 13, 96, 167,
    116, 85, 13, 11, 195, 18, 81, 206, 182, 90, 97, 214, 1, 58, 75, 80, 192,
    226, 217, 160, 127, 41, 181, 223, 41, 206, 20, 39, 232, 23, 169, 45, 1, 108,
    146, 145, 71, 170, 23, 157, 89, 28, 27, 95, 159, 120, 166, 92, 134, 194,
    196, 55, 23, 98, 154, 117, 55, 241, 16, 239, 151, 127, 132, 163, 197, 167,
    200, 3, 172, 66, 108, 248, 210, 101, 128, 145, 155, 188, 58, 224, 215, 203,
    240, 247, 30, 235, 237, 109, 227, 107, 75, 172, 247, 213, 190, 127, 5, 0,
    209, 240, 208, 29, 192, 40, 185, 0, 32, 94, 231, 241, 220, 31, 175, 12, 145,
    149, 107, 249, 29, 175, 80, 95, 30, 102, 250, 129, 150, 228, 108, 227, 186,
    90, 87, 67, 9, 48, 66, 34, 140, 114, 56, 65, 233, 164, 180, 121, 100, 109,
    133, 137, 124, 123, 242, 134, 47, 33, 60, 164, 15, 95, 210, 97, 206, 187,
    255, 23, 101, 145, 224, 157, 157, 2, 180, 11, 68, 230, 224, 90, 196, 180,
    33, 9, 21, 193, 135, 165, 131, 6, 150, 63, 120, 75, 247, 128, 248, 112, 29,
    121, 178, 116, 15, 237, 153, 244, 171, 239, 23, 201, 181, 235, 155, 255, 2,
    53, 145, 45, 110 };

#include <iostream>
#include <sstream>

void pure_lua_deferred_open(lua_State* L)
{

    std::string luacode(
        luacode_bytearray, luacode_bytearray + sizeof(luacode_bytearray));
    std::istringstream is(luacode);
    nx::pipe::source_t source(is);

    std::stringstream out;
    nx::pipe::sink_t sink(out);

    nx::pipe::filter::unzlib_t unzlib;

    source | unzlib | sink;

    if (luaL_dostring(L, out.str().c_str())) {
        std::cerr << lua_tostring(L, -1) << std::endl;
    }
}